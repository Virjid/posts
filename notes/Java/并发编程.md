[TOC]

# å¹¶å‘ä¸å¹¶è¡Œ

## 1. ä»€ä¹ˆæ˜¯å¹¶å‘

å¹¶å‘æ˜¯æŒ‡ä¸€ä¸ªå¤„ç†å™¨åŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡ã€‚



## 2. ä»€ä¹ˆæ˜¯å¹¶è¡Œ

å¹¶è¡Œæ˜¯æŒ‡å¤šä¸ªå¤„ç†å™¨æˆ–è€…æ˜¯å¤šæ ¸çš„å¤„ç†å™¨åŒæ—¶å¤„ç†å¤šä¸ªä¸åŒçš„ä»»åŠ¡ã€‚ 



## 3. å¹¶å‘ä¸å¹¶è¡Œçš„åŒºåˆ«

å¹¶å‘æ˜¯é€»è¾‘ä¸Šçš„åŒæ—¶å‘ç”Ÿï¼ˆsimultaneousï¼‰ï¼Œè€Œå¹¶è¡Œæ˜¯ç‰©ç†ä¸Šçš„åŒæ—¶å‘ç”Ÿã€‚ä¹Ÿå¯ä»¥è¯´ï¼Œå¹¶å‘æ˜¯å®è§‚ä¸Šçš„åŒæ—¶å‘ç”Ÿï¼Œè€Œå¹¶è¡Œæ˜¯å¾®è§‚ä¸Šçš„åŒæ—¶å‘ç”Ÿã€‚



# çº¿ç¨‹

## 1. è¿›ç¨‹ä¸çº¿ç¨‹

è¿›ç¨‹æ˜¯æœ€å°çš„èµ„æºåˆ†é…å•å…ƒï¼Œè€Œçº¿ç¨‹æ˜¯æœ€å°çš„ä»»åŠ¡æ‰§è¡Œå•å…ƒã€‚



## 2. çº¿ç¨‹çš„çŠ¶æ€

- æ–°å»º                   NEW
- å¯è¿è¡Œ               Runnable
- é˜»å¡                   Blocked
- ç­‰å¾…                   Waiting
- å®šæ—¶ç­‰å¾…           Time Waiting
- æ­»äº¡                   Terminated

<img src="pics/thread-1.png" height="350px" />

## 3. Java çº¿ç¨‹çš„åŸºæœ¬æ“ä½œ

### 3.1 æ–°å»ºçº¿ç¨‹

#### 3.1.1 ç»§æ‰¿äº Thread

```java
Thread thread = new Thread() {
    @Override
    public void run() {
        System.out.println("...");
    }
};

thread.start();
```



#### 3.1.2 å®ç° Runnable æ¥å£

```java
Thread thread = new Thread(new Runnable() {
    @Override
    public void run() {
        System.out.println("...");
    }
});
		
thread.start();
```



å®é™…ä¸Š Thread è‡ªèº«ä¹Ÿå®ç°äº† Runnable æ¥å£ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰æœ‰äº†ç¬¬ä¸€ç§åˆ›å»ºçº¿ç¨‹çš„æ–¹æ³•ï¼ˆç»§æ‰¿ Thread ï¼‰ï¼ŒThread ç±»çš„ä»£ç ç‰‡æ®µï¼š

```java
public class Thread implements Runnable {
    // ... ...
    
    /* What will be run. */
    private Runnable target;
    
    // ... ...
    @Override
    public void run() {
        if (target != null) {
            target.run();
        }
    }
    // ... ...
}
```



#### 3.1.3 å®ç° Callable æ¥å£

```java
FutureTask<String> task = new FutureTask<>(new Callable<String>() {
    @Override
    public String call() throws Exception {
        System.out.println("...");
        Thread.sleep(2000);
        return "hello";
    }
});

new Thread(task).start();

System.out.println(task.get()); // hello æ­¤å¤„ä¼šå‘ç”Ÿé˜»å¡
```



#### 3.1.4 çº¿ç¨‹å·¥å‚

```java
ThreadFactory factory = Executors.defaultThreadFactory();

Thread thread = factory.newThread(new Runnable() {
    @Override
    public void run() {
        System.out.println("....");
    }
});

thread.start();
```



#### 3.1.5 ä½¿ç”¨çº¿ç¨‹æ± 

```java
ExecutorService service = Executors.newCachedThreadPool();

Future<String> future = service.submit(new Callable<String>() {
    @Override
    public String call() throws Exception {
        System.out.println("...");
        Thread.sleep(2000);
        return "hello";
    }
});

System.out.println(future.get());
```



### 3.2 ç»ˆæ­¢çº¿ç¨‹

JDK æä¾›äº†æˆå‘˜æ–¹æ³• `stop()` æ–¹æ³•æ¥ç»ˆæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼š

```java
public static void main(String[] args) throws Exception {
    Thread t1 = new Thread() {
        while (true) {
            System.out.println("...");
        }
    }
    
    t1.start(); // å¯åŠ¨çº¿ç¨‹
    Thread.sleep(2000); // é˜»å¡ä¸€æ®µæ—¶é—´
    t1.stop(); // ç»ˆæ­¢ t1 çº¿ç¨‹
}
```

å½“ä¸€ä¸ªçº¿ç¨‹è¢« stop åï¼Œå®ƒä¼šå°†è‡ªå·±æ‰€æŒæœ‰çš„æ‰€æœ‰é”è¿›è¡Œé‡Šæ”¾ï¼Œä½†ç”±äº stop å¤ªè¿‡ã€Œæš´åŠ›ã€è€Œè¢«æ ‡è®°ä¸ºä¸æ¨èä½¿ç”¨ã€‚

:x: å‡è®¾ä¸€æ¡çº¿ç¨‹æŠ¢åˆ°é”åå¯¹ä¸´ç•Œèµ„æºæ“ä½œåˆ°ä¸€åŠå°±è¢«ç»ˆæ­¢äº†ã€‚æ­¤æ—¶é”è¢«é‡Šæ”¾ï¼Œè€Œä¸´ç•Œèµ„æºå¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ï¼Œå…¶å®ƒçº¿ç¨‹æŠ¢åˆ°é”åè‡ªç„¶å°±ä¼šè®¿é—®åˆ°é”™è¯¯çš„æ•°æ®ã€‚



### 3.3 çº¿ç¨‹ä¸­æ–­

çº¿ç¨‹ä¸­æ–­å¹¶ä¸ä¼šä½¿å¾—çº¿ç¨‹ç«‹å³åœæ­¢ï¼Œè¿™æ˜¯å’Œ stop æœ€å¤§çš„ä¸åŒç‚¹ï¼Œä¹Ÿæ˜¯ç›¸æ¯” stop çš„ä¼˜åŠ¿ã€‚å®é™…ä¸Šï¼Œå½“ä¸­æ–­ç›®æ ‡çº¿ç¨‹æ—¶ï¼Œå®é™…ä¸Šæ˜¯å‘ç›®æ ‡çº¿ç¨‹å‘é€ä¸­æ–­é€šçŸ¥ï¼Œè‡³äºæ˜¯å¦ç»“æŸè‡ªå·±çš„ â€œç”Ÿå‘½â€ ä¾ç„¶ç”±ç›®æ ‡çº¿ç¨‹è‡ªå·±æ¥å†³å®šã€‚

æ¶‰åŠåˆ°ä¸­æ–­çš„æ–¹æ³•ä¸»è¦æœ‰å¦‚ä¸‹ä¸‰ä¸ªï¼š

- `public void Thread.interrupt()`                          ä¸­æ–­çº¿ç¨‹ï¼Œå‘é€ä¸­æ–­é€šçŸ¥
- `public boolean Thread.isInterrupted() `            åˆ¤æ–­æ˜¯å¦è¢«ä¸­æ–­
- `public boolean Thread.interrupted()`                åˆ¤æ–­æ˜¯å¦è¢«ä¸­æ–­å¹¶æ¸…é™¤ä¸­æ–­çŠ¶æ€



```java
public static void main(String[] args) throws InterruptedException {
	Thread t = new Thread(()->{
		while(true) {
            // åˆ¤æ–­æ˜¯å¦è¢«ä¸­æ–­ï¼Œå¹¶æ¸…é™¤ä¸­æ–­çŠ¶æ€
			if (Thread.currentThread().isInterrupted()) {
                // åšä¸€äº›å¤„ç†ä»¥åå†é€€å‡º
				System.out.println("......");
				break;
			} else {
                // æ­£å¸¸å·¥ä½œing...
				System.out.println("#####");
			}
		}
	});
    
	t.start();
	Thread.sleep(2000);
	t.interrupt();
}
```



### 3.4 wait & notify





### 3.5 suspend & resume

suspend è¡¨ç¤ºæŒ‚èµ·çº¿ç¨‹ï¼Œè€Œ resume æ—¶ä¸ä¹‹ç›¸åçš„æ‰§è¡Œçº¿ç¨‹ã€‚ä¸è¿‡è¿™ä¸€å¯¹æ“ä½œå·²ç»è¢«æ ‡æ³¨ä¸ºåºŸå¼ƒï¼Œè¿™æ˜¯å› ä¸º ï¼š

- é¦–å…ˆï¼Œsuspend åœ¨æŒ‚èµ·çº¿ç¨‹çš„åŒæ—¶å¹¶ **ä¸ä¼šé‡Šæ”¾èµ„æº** ï¼Œè¿™ä¼šå¯¼è‡´ä¸è¯¥èµ„æºç›¸å…³çš„çº¿ç¨‹å‡ ä¹éƒ½ä¼šå—åˆ°ç‰µè¿ã€‚
- å…¶æ¬¡ï¼Œé€šå¸¸çš„éœ€æ±‚æ˜¯åœ¨ suspend æ“ä½œä¹‹åçš„æŸä¸€åˆ»å†æ‰§è¡Œ resumeï¼Œä½†ä¸€æ—¦ä¸å°å¿ƒå…ˆæ‰§è¡Œäº† resumeï¼Œé‚£ä¹ˆè¢«æŒ‚èµ·çš„çº¿ç¨‹å°±å¾ˆæœ‰å¯èƒ½æ— æ³•å†æœ‰æœºä¼šç»§ç»­æ‰§è¡Œäº†ã€‚



### 3.6 join & yield





### 3.7 sleep & wait

- sleep å’Œ wait éƒ½å¯ä»¥ä½¿çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼ˆå‡†ç¡®åœ°è¯´æ˜¯å®šæ—¶ç­‰å¾…ï¼‰ã€‚
- æ— è®ºæ˜¯ä½¿ç”¨ sleep è¿˜æ˜¯ wait è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œçº¿ç¨‹éƒ½å¯ä»¥è¢«ä¸­æ–­ï¼ˆinterruptï¼‰ã€‚
- sleep å’Œ wait ä¹‹åï¼Œçº¿ç¨‹éƒ½ä¼šè®©å‡º CPU ã€‚å½“æœ‰å¤§é‡çº¿ç¨‹åŒæ—¶ sleep æ—¶ä¸ä¼šå¯¹ CPU æœ‰ä»€ä¹ˆå½±å“ï¼Œä½†æ˜¯å¤§é‡çš„çº¿ç¨‹å¯¹è±¡å¯èƒ½ä¼šå æ®å¤ªå¤šå†…å­˜ã€‚



- åœ¨ synchronized åŒæ­¥å—ä¸­ï¼Œ wait ä¹‹åçº¿ç¨‹ä¼šé‡Šæ”¾é”ï¼Œä½† sleep ä¹‹åå¹¶ä¸ä¼šé‡Šæ”¾é”ã€‚
- wait åè¿˜å¯ä»¥ä½¿ç”¨ notify æ¥å”¤é†’çº¿ç¨‹ï¼Œä½† sleep ä¹‹åçº¿ç¨‹ä¸èƒ½è¢«å”¤é†’ã€‚



## 4. çº¿ç¨‹çš„ä¼˜å…ˆçº§



## 5. å®ˆæŠ¤çº¿ç¨‹



# çº¿ç¨‹æ± 

## 1. å°è¯•è‡ªå·±å®ç°çº¿ç¨‹æ± 



## 2. Executor æ¡†æ¶

### 2.1 æ¦‚è¿°

Java ä¸€å¼€å§‹åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼ä½¿å¾—ä»»åŠ¡å’Œæ‰§è¡Œè€¦åˆåœ¨äº†ä¸€èµ·ï¼Œè€Œåæ¥ JDK ä¸­å‡ºç°äº† Executor æ¡†æ¶åˆ†ç¦»äº†ä»»åŠ¡ä¸æ‰§è¡Œã€‚å…¶ä¸­ä»»åŠ¡å¯ä»¥æ˜¯ Runnable å’Œ Callableï¼Œè€Œæ‰§è¡Œæœºåˆ¶ç”± Executor æ¥æä¾›ã€‚



Executor æä¾›çš„ä¸¤çº§è°ƒåº¦æ¨¡å‹ï¼š

<left><img src="pics/thread-2.png" height="450px"/></left>
Executor æ¡†æ¶ä¸»è¦ç”± 3 éƒ¨åˆ†ç»„æˆï¼š

- ä»»åŠ¡
- ä»»åŠ¡çš„æ‰§è¡Œ
- å¼‚æ­¥æ‰§è¡Œç»“æœ



<left><img src="pics/thread-3.png" height="450px"/></left>
### 2.2 Executor æ¡†æ¶çš„ä¸»è¦æˆå‘˜

#### 2.2.1 ThreadPoolExecutor

ThreadPoolExecutor æ˜¯çº¿ç¨‹æ± çš„æ ¸å¿ƒå®ç°ç±»ï¼Œç”¨æ¥æ‰§è¡Œè¢«æäº¤çš„ä»»åŠ¡ï¼Œä¸€èˆ¬ä½¿ç”¨å·¥å‚ç±» **`Executors`** è¿›è¡Œåˆ›å»ºï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥å®ä¾‹åŒ–å¯¹è±¡ã€‚

Executors å¯ä»¥åˆ›å»º 3 ç§ç±»å‹çš„ ThreadPoolExecutorï¼š

- CachedThreadPool
- FixedThreadPool
- SingleThreadExecutor



**# FixedThreadPool**

FixedThreadPool å¯ä»¥ç”¨äºåˆ›å»ºæ‹¥æœ‰å›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± ï¼š

```java
ExecutorService es = Executors.newFixedThreadPool(5);
es.execute(new Runnable() {
    @Override
    public void run() {
        System.out.println("...");
    }
});
es.shutdown();

```

FixedThreadPool é€‚ç”¨äºä¸ºäº†æ»¡è¶³èµ„æºç®¡ç†çš„éœ€æ±‚ï¼Œè€Œéœ€è¦é™åˆ¶å½“å‰çº¿ç¨‹æ•°é‡çš„åº”ç”¨åœºæ™¯ï¼Œå®ƒé€‚ç”¨äºè´Ÿè½½æ¯”è¾ƒé‡çš„æœåŠ¡å™¨ã€‚



**# SingleThreadExecutor**

SingleThreadExecutor ç›¸å½“äºçº¿ç¨‹æ•°é‡ä¸º 1 çš„ FixedThreadPoolï¼š

```java
ExecutorService es = Executors.newSingleThreadExecutor();

```

SingleThreadExecutor é€‚ç”¨äºéœ€è¦ä¿è¯é¡ºåºåœ°æ‰§è¡Œå„ä¸ªä»»åŠ¡ï¼›å¹¶ä¸”åœ¨ä»»æ„æ—¶é—´ç‚¹ï¼Œä¸ä¼šæœ‰å¤šä¸ªçº¿ç¨‹æ˜¯æ´»åŠ¨çš„åº”ç”¨åœºæ™¯ã€‚



**# CachedThreadPool**

```java
ExecutorService es = Executors.newCachedThreadPool();

```

CachedThreadPoolæ˜¯å¤§å°æ— ç•Œçš„çº¿ç¨‹æ± ï¼Œé€‚ç”¨äºæ‰§è¡Œå¾ˆå¤šçš„çŸ­æœŸå¼‚æ­¥ä»»åŠ¡çš„å°ç¨‹åºï¼Œæˆ–è€…æ˜¯è´Ÿè½½è¾ƒè½»çš„æœåŠ¡å™¨ã€‚



#### 2.2.2 ScheduledThreadPool



#### 2.2.3 Future



#### 2.2.4 Runnable & Callable



# çº¿ç¨‹å®‰å…¨

## 1. æ­»é”

### 1.1 æ­»é”çš„åŸå› 

å½“å¤šæ¡çº¿ç¨‹äº‰å¤ºå¤šä¸ªèµ„æºæ—¶ï¼Œå°±æœ‰å¯èƒ½å‡ºç°æ­»é”çš„æƒ…å†µã€‚ä¸ºæ–¹ä¾¿æè¿°ï¼Œå‡è®¾ä»…æœ‰ä¸¤æ¡çº¿ç¨‹ Aã€B å’Œ ä¸¤ä¸ªèµ„æº aã€bï¼ŒA å’Œ B å¿…é¡»éƒ½åŒæ—¶æ‹¥æœ‰ä¸¤ä¸ªèµ„æºæ‰èƒ½ç»§ç»­æ‰§è¡Œä¸‹å»ã€‚è‹¥ç°åœ¨ A å æœ‰äº† èµ„æº aï¼ŒB å æœ‰äº†èµ„æº bï¼Œæ‰€ä»¥ A æ— æ³•è·å¾—èµ„æº bï¼Œè€Œ B ä¹Ÿæ— æ³•è·å¾—èµ„æº aï¼ŒAã€B ä¸€ç›´ä¿æŒç€åƒµæŒçŠ¶æ€ï¼Œæ•´ä¸ªç¨‹åºæ°¸è¿œæ— æ³•ç»§ç»­æ‰§è¡Œä¸‹å»ã€‚

### 1.2 è‡ªå·±å†™ä¸€ä¸ªæ­»é”



### 1.3 è§£å†³æ­»é”çš„åŠæ³•



# é”

## 1. åŒæ­¥ä¸äº’æ–¥

- åŒæ­¥ï¼šåˆç§° **ç›´æ¥åˆ¶çº¦å…³ç³»**ï¼Œæ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹ï¼ˆæˆ–è¿›ç¨‹ï¼‰ä¸ºäº†åˆä½œå®Œæˆä»»åŠ¡ï¼Œå¿…é¡»ä¸¥æ ¼æŒ‰ç…§è§„å®šçš„ æŸç§å…ˆåæ¬¡åºæ¥è¿è¡Œã€‚



- äº’æ–¥ï¼šåˆç§° **é—´æ¥åˆ¶çº¦å…³ç³»**ï¼Œæ˜¯æŒ‡ç³»ç»Ÿä¸­çš„æŸäº›å…±äº«èµ„æºï¼Œä¸€æ¬¡åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®ã€‚å½“ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨è®¿é—®è¯¥ä¸´ç•Œèµ„æºæ—¶ï¼Œå…¶å®ƒçº¿ç¨‹å¿…é¡»ç­‰å¾…ã€‚



## 2. synchronized å…³é”®è¯

synchronized æ˜¯ç”± JVM å®ç°çš„ä¸€ç§èƒ½å¤Ÿè¾¾åˆ°åŒæ­¥æˆ–äº’æ–¥ç›®çš„çš„é”æœºåˆ¶ã€‚synchronized å¯ä»¥ä½œç”¨åœ¨æ–¹æ³•æˆ–ä»£ç å—ï¼Œå¹¶éœ€è¦æŒ‡å®šæ‰€ä½¿ç”¨çš„é”ï¼ˆåœ¨ Java ä¸­ **ä»»ä½•** å¯¹è±¡çš†å¯ä»¥å……å½“é”ï¼‰ï¼š

```java

public class TestLock {
	private static class Task implements Runnable {
		@Override
		public void run() {
			Object lock = new Object();
			
            /*
             * å°†ä¸€ä¸ª Object å¯¹è±¡ lock ä½œä¸ºä¸€æŠŠé”ã€‚ä»»ä½•çº¿ç¨‹è¦è®¿é—®è¢« synchronized å…³é”®è¯
             * æ ‡è¯†çš„ä»£ç å—ï¼Œå¿…é¡»å»å°è¯•äº‰æŠ¢ lock è¿™æŠŠé”ã€‚åªæœ‰æ‹¥æœ‰é”çš„çº¿ç¨‹æ‰å¯ä»¥è¿›å…¥ä»£ç å—ï¼Œ
             * å¦åˆ™åªèƒ½è¿›å…¥é˜»å¡æ€ç­‰å¾…ä¸‹ä¸€æ¬¡æŠ¢é”æœºä¼šçš„åˆ°æ¥ã€‚
             */
			synchronized(lock) {
				System.out.println(Thread.currentThread());
			}
			
		}
	}
	
	
	public static void main(String[] args) {
		Thread t1 = new Thread(new Task());
		Thread t2 = new Thread(new Task());
		
        /*
         * t1 å’Œ t2 ä¼šç»å†æŠ¢é”çš„è¿‡ç¨‹ï¼Œä½†æˆ‘ä»¬ä¾ç„¶æ— æ³•æ–­å®šåˆ°åº•æ˜¯å“ªä¸€ä¸ªçº¿ç¨‹ 
         * ä¼šå…ˆæ‰§è¡Œæ‰“å°è¯­å¥ï¼Œå› ä¸ºæŠ¢é”ç»“æœæ˜¯éšæœºçš„ï¼Œæˆ‘ä»¬æ— æ³•åˆ¤æ–­è°ä¼šå…ˆæŠ¢å¾—
         * é”ã€‚ä¸è¿‡æˆ‘ä»¬å¯ä»¥æ–­å®šçš„æ˜¯ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œæ‰“å°è¯­å¥æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹
         * ç»æ— æ‰§è¡Œæ‰“å°è¯­å¥çš„å¯èƒ½ã€‚
         */
		t1.start();
		t2.start();
	}
}

```



ä¸Šé¢æ˜¯ä¸€ä¸ª synchronized ä¿®é¥°ä»£ç å—çš„ä¾‹å­ï¼Œæ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ä¿®é¥°æˆå‘˜æ–¹æ³•å’Œé™æ€æ–¹æ³•çš„ä¾‹å­ï¼š

```java

public class TestLock {
	public synchronized void test() {
		System.out.println(Thread.currentThread());
	}
	
	public synchronized static void test2() {
		System.out.println(Thread.currentThread());
	}
}

```



å®é™…ä¸Šæ–¹æ³•ä¹Ÿæ˜¯ä»£ç å—ï¼Œæ‰€ä»¥ç†è§£æ–¹å¼å¹¶æ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼Œåªæ˜¯æˆ‘ä»¬æ²¡æœ‰å†è‡ªå·±æŒ‡å®šé”å¯¹è±¡äº†ã€‚å‡†ç¡®åœ°è¯´ï¼Œæ˜¯éšå¼æŒ‡å®šäº†é”å¯¹è±¡ï¼Œä¸Šé¢çš„ä»£ç ç­‰ä»·äºï¼š

```java

public class TestLock {
    // æˆå‘˜æ–¹æ³•å®é™…ä¸Šä½¿ç”¨çš„æ˜¯ this å¯¹è±¡ä½œä¸ºé”
	public void test() {
		synchronized (this) {
			System.out.println(Thread.currentThread());
		}
	}
    
    // é™æ€æ–¹æ³•åˆ™æ˜¯ä½¿ç”¨ç›¸åº”çš„å…ƒç±»å¯¹è±¡ä½œä¸ºé”
	public static void test2() {
		synchronized (TestLock.class) {
			System.out.println(Thread.currentThread());
		}
	}
}

```



## 3. Lock æ¥å£

synchronized å°†**ã€Œè·å–é” â€” æ‰§è¡Œ â€” é‡Šæ”¾é”ã€**è¿™ä¸€è¿‡ç¨‹éšè—äº†èµ·æ¥ï¼Œä½¿ç”¨èµ·æ¥è™½ç„¶æ–¹ä¾¿ä½†å´ä¸çµæ´»ã€‚åœ¨ `java.util.concurrent.locks` åŒ…ä¸‹æœ‰å®šä¹‰äº†ä¸€ä¸ªåä¸º `Lock` çš„æ¥å£ï¼Œå®ƒç”¨äºå®ç°åƒ synchronized å…³é”®è¯ä¸€æ ·çš„åŠŸèƒ½ï¼Œä½†éœ€è¦æ˜¾ç¤ºåœ°å»è·å–ã€é‡Šæ”¾é”ã€‚è¿™å¬èµ·æ¥å¥½åƒå˜éº»çƒ¦äº†ï¼Œä½†ä¹Ÿå¸¦ç»™äº†æˆ‘ä»¬æ›´å¤§çš„çµæ´»æ€§ã€‚



```java

Lock lock = new ReentrantLock(); // è·å¾—é”å¯¹è±¡

lock.lock(); // åŠ é”
try {
    System.out.println("...");
} finally {
    lock.unlock(); // é‡Šæ”¾é”
}

```



`ReentrantLock` æ˜¯ Lock æ¥å£çš„ä¸€ä¸ªå®ç°ç±»ï¼Œä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹ä½œï¼š

```java

synchronized(Object.class) { // å¯ä»¥é€‰ç”¨ä»»æ„çš„å¯¹è±¡ä½œä¸ºé”
    System.out.println("...");
}

```



## 4. å¯é‡å…¥é” ReentrantLock

å°±åœ¨åˆšæ‰æˆ‘ä»¬å·²ç»è§è¿‡äº†å¯é‡å…¥é”ï¼Œç°åœ¨è§£é‡Šä¸€ä¸‹ä»€ä¹ˆå«ä½œ **ã€Œå¯é‡å…¥é”ã€** ï¼š

> é‡å…¥é”ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯æ”¯æŒé‡è¿›å…¥çš„é”ï¼Œå®ƒè¡¨ç¤ºè¯¥é”èƒ½å¤Ÿæ”¯æŒä¸€ä¸ªçº¿ç¨‹å¯¹èµ„æºçš„é‡å¤åŠ é”ã€‚



æƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼Œæˆ‘ä»¬åœ¨å¾ªç¯ä»£ç å— **å†…éƒ¨** è¿›è¡ŒåŠ é”ã€‚

- ç¬¬ä¸€æ¬¡å¾ªç¯æ—¶ï¼Œçº¿ç¨‹æŠ¢åˆ°é”åä¾¿èƒ½å¤Ÿé¡ºåˆ©æ‰§è¡Œä¸‹å»ã€‚
- ç¬¬äºŒæ¬¡å¾ªç¯æ—¶ï¼Œåˆè¦æ±‚åŠ é”ã€‚æ­¤æ—¶å¦‚æœæ˜¯ **ä¸å¯é‡å…¥é”** ï¼Œå°±ä¸èƒ½é‡å¤åŠ é”ï¼Œå³ä½¿æ‰‹ä¸Šæœ‰é”ä¹Ÿæ— æ³•æ‰§è¡Œäº†ã€‚



ç°åœ¨æˆ‘ä»¬å†™ä¸€ä¸ªç®€æ˜“çš„ä¸å¯é‡å…¥é”æ¥æ¨¡æ‹Ÿä¸Šè¿°æƒ…æ™¯ï¼š

```java
// ä¸€ä¸ªä¸å¯é‡å…¥é”
public class MyLock {
	private boolean isLocked = false;

	public synchronized void lock() throws InterruptedException {
		while (isLocked) {
			wait();
		}
		isLocked = true;
	}

	public synchronized void unlock() {
		isLocked = false;
		notify();
	}
}


// æ¨¡æ‹Ÿæƒ…æ™¯
public class TestLock {
	public static void lockInvoke() throws Exception {
		MyLock lock = new MyLock();
		int i = 0;
		while(i++ < 10) {
			lock.lock();
			System.out.println("....");
		}
		lock.unlock();
	}
	
	public static void main(String[] args) throws Exception {
		lockInvoke();
	}
}


// è¾“å‡ºæƒ…å†µï¼šåªä¼šæ‰“å°ä¸€æ¬¡ ... ï¼Œä¸”ç¨‹åºä¸æ–­è¿è¡Œæ— æ³•è‡ªå·±ç»ˆæ­¢ã€‚
```



ç°åœ¨å†æ›¿æ¢æˆå¯é‡å…¥é”æŸ¥çœ‹æ•ˆæœï¼š

```java
public class TestLock {
	public static void lockInvoke() throws Exception {
		Lock lock = new ReentrantLock(); // åªéœ€è¦æ›¿æ¢æ­¤å¤„ä¸ºå¯é‡å…¥é”å³å¯
		int i = 0;
		while(i++ < 10) {
			lock.lock();
			System.out.println("....");
		}
		lock.unlock();
	}
	
	public static void main(String[] args) throws Exception {
		lockInvoke();
	}
}


// è¾“å‡ºæƒ…å†µï¼šä¼šæ‰“å°åæ¬¡ ... ï¼Œä¸”ç¨‹åºè‡ªå·±ç»ˆæ­¢ã€‚
```



## 5. ReentrantLock ä¸ synchronized



å®é™…ä¸Šä½¿ç”¨ synchronized åŒæ ·æ˜¯ **å¯é‡å…¥çš„** ï¼Œä¸‹é¢ä¸¾å‡ºä¸€äº›ä¸¤è€…ä¹‹é—´çš„åŒºåˆ«ï¼š

<!-- ä½¿ç”¨ synchronized æ˜¯æ— æ³•é‡ç°ä¸Šé¢çš„æƒ…æ™¯çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¯´ synchronized ä¸çµæ´» -->

**1. é”çš„å®ç°**

synchronized æ˜¯ JVM å®ç°çš„ï¼Œè€Œ ReentrantLock æ˜¯ JDK å®ç°çš„ã€‚

**2. æ€§èƒ½**

æ–°ç‰ˆæœ¬ Java å¯¹ synchronized è¿›è¡Œäº†å¾ˆå¤šä¼˜åŒ–ï¼Œä¾‹å¦‚è‡ªæ—‹é”ç­‰ï¼Œsynchronized ä¸ ReentrantLock å¤§è‡´ç›¸åŒã€‚

**3. ç­‰å¾…å¯ä¸­æ–­**

å½“æŒæœ‰é”çš„çº¿ç¨‹é•¿æœŸä¸é‡Šæ”¾é”çš„æ—¶å€™ï¼Œæ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥é€‰æ‹©æ”¾å¼ƒç­‰å¾…ï¼Œæ”¹ä¸ºå¤„ç†å…¶ä»–äº‹æƒ…ã€‚

ReentrantLock å¯ä¸­æ–­ï¼Œè€Œ synchronized ä¸è¡Œã€‚

**4. å…¬å¹³é”**

å…¬å¹³é”æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹åœ¨ç­‰å¾…åŒä¸€ä¸ªé”æ—¶ï¼Œå¿…é¡»æŒ‰ç…§ç”³è¯·é”çš„æ—¶é—´é¡ºåºæ¥ä¾æ¬¡è·å¾—é”ã€‚

synchronized ä¸­çš„é”æ˜¯éå…¬å¹³çš„ï¼ŒReentrantLock é»˜è®¤æƒ…å†µä¸‹ä¹Ÿæ˜¯éå…¬å¹³çš„ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥æ˜¯å…¬å¹³çš„ã€‚

**5. é”ç»‘å®šå¤šä¸ªæ¡ä»¶**

ä¸€ä¸ª ReentrantLock å¯ä»¥åŒæ—¶ç»‘å®šå¤šä¸ª Condition å¯¹è±¡ã€‚



## 6. æ’ä»–é”

æ— è®ºæ˜¯ ReentrantLock è¿˜æ˜¯ synchronized ï¼Œå®ƒä»¬éƒ½å±äºæ’ä»–é”ã€‚æ‰€è°“**ã€Œæ’ä»–é”ã€**ï¼Œå³åœ¨åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€æ¡çº¿ç¨‹æŒæœ‰è¯¥é”ã€‚



## 7. è¯»å†™é”

åœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œæ’ä»–é”çš„è®¾è®¡å¹¶ä¸æ˜¯é‚£ä¹ˆåˆç†ã€‚æ¯”å¦‚ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬å¸Œæœ›åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€æ¡çº¿ç¨‹è¿›è¡Œå†™æ“ä½œï¼Œä½†å…è®¸å¤šæ¡çº¿ç¨‹è¿›è¡Œè¯»æ“ä½œã€‚å…·ä½“åœ°è¯´ï¼Œæˆ‘ä»¬éœ€è¦çš„è¯»å†™é”è‡³å°‘éœ€è¦å¦‚ä¸‹ç‰¹ç‚¹ï¼š

- å½“æœ‰çº¿ç¨‹è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œä¸èƒ½æœ‰å…¶å®ƒä»»ä½•çº¿ç¨‹è¿›è¡Œè¯»å†™æ“ä½œ
- å½“æœ‰çº¿ç¨‹è¿›è¡Œè¯»æ“ä½œæ—¶ï¼Œå¯ä»¥æœ‰å…¶ä»–çº¿ç¨‹åŒæ—¶è¿›è¡Œè¯»æ“ä½œï¼Œä½†ä¸èƒ½æœ‰ä»»ä½•çš„çº¿ç¨‹è¿›è¡Œå†™æ“ä½œ



Java æä¾›äº†ä¸€ä¸ªè¯»å†™é”çš„æ¥å£ ReadWriteLock ï¼Œå®ƒçš„ä¸€ä¸ªå®ç° ReentrantReadWriteLock å…·æœ‰å¦‚ä¸‹é¢å¤–çš„ç‰¹ç‚¹ï¼š

- å…¬å¹³æ€§é€‰æ‹©
- å¯é‡è¿›å…¥
- é”é™çº§



## 8. LockSupport

```java
public class LockSupportTests {
    public static void main(String[] args) {
        Thread thread = new Thread(()->{
            try {
                Thread.sleep(5000);
                LockSupport.park();
                System.out.println("park end...");
            } catch (Exception e) {e.printStackTrace();}
        });
        thread.start();

        LockSupport.unpark(thread);
    }
}
```



## 9. AQS

### 9.1 åŸç†æ¦‚è¿°

AQS å…¨ç§°ä¸º AbstractQueuedSynchronizer ï¼Œå…¶æœ¬è´¨å…¶å®æ˜¯ä¸€ä¸ª **åŒå‘é˜Ÿåˆ—**ï¼Œé˜Ÿåˆ—çš„å…ƒç´ æ˜¯å†…éƒ¨ç±» Node çš„å®ä¾‹å¯¹è±¡ï¼Œè€Œæ¯ä¸€ä¸ª Node ç»“ç‚¹éƒ½å«æœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ï¼š

<img src="pics/thread-11.png" width="550"/>

AQS çš„æ ¸å¿ƒç†å¿µæ˜¯ï¼š

- å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶å°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€ã€‚
- å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€å¥—çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠå”¤é†’æ—¶é”åˆ†é…çš„æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶ AQS æ˜¯ç”¨ CLH é˜Ÿåˆ—é”å®ç°çš„ï¼Œå³å°†å±•ç¤ºè·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚ 



AQS ä½¿ç”¨ä¸€ä¸ª int æˆå‘˜å˜é‡æ¥è¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œé€šè¿‡å†…ç½®çš„ FIFO é˜Ÿåˆ—æ¥å®Œæˆè·å–èµ„æºçº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œã€‚AQS ä½¿ç”¨ CAS å¯¹è¯¥åŒæ­¥çŠ¶æ€è¿›è¡ŒåŸå­æ“ä½œå®ç°å¯¹å…¶å€¼çš„ä¿®æ”¹ã€‚

```java
private volatile int state;// å…±äº«å˜é‡ï¼Œä½¿ç”¨volatileä¿®é¥°ä¿è¯çº¿ç¨‹å¯è§æ€§
```



çŠ¶æ€ä¿¡æ¯é€šè¿‡ protected ç±»å‹çš„ getState ï¼ŒsetState ï¼ŒcompareAndSetState è¿›è¡Œæ“ä½œ

```java
//è¿”å›åŒæ­¥çŠ¶æ€çš„å½“å‰å€¼
protected final int getState() {  
    return state;
}

// è®¾ç½®åŒæ­¥çŠ¶æ€çš„å€¼
protected final void setState(int newState) { 
    state = newState;
}

//åŸå­åœ°ï¼ˆCASæ“ä½œï¼‰å°†åŒæ­¥çŠ¶æ€å€¼è®¾ç½®ä¸ºç»™å®šå€¼updateå¦‚æœå½“å‰åŒæ­¥çŠ¶æ€çš„å€¼ç­‰äºexpectï¼ˆæœŸæœ›å€¼ï¼‰
protected final boolean compareAndSetState(int expect, int update) {
    return unsafe.compareAndSwapInt(this, stateOffset, expect, update);
}
```



### 9.2 Node ç»“ç‚¹

å‰é¢è¯´äº† AQS æœ¬è´¨æ˜¯ä¸€ä¸ªåŒå‘é˜Ÿåˆ—ï¼Œè€Œè¿™ä¸ªé˜Ÿåˆ—ä¸­å…ƒç´ éƒ½ä¸º Node å®ä¾‹å¯¹è±¡ï¼Œå…¶ä¸­ Node ç±»çš„ç±»å›¾å¦‚ä¸‹ï¼š

<left><img src="pics/thread-12.png" width="300"/></left>
- thread å˜é‡ç”¨äºå­˜æ”¾ AQS é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹
- SHARED ç”¨æ¥æ ‡è®°çº¿ç¨‹æ˜¯è·å–å…±äº«èµ„æºæ—¶è¢«é˜»å¡æŒ‚èµ·çš„
- EXCLIUSIVE ç”¨æ¥æ ‡è®°çº¿ç¨‹æ˜¯è·å–ç‹¬å èµ„æºæ—¶è¢«æŒ‚èµ·çš„
- waitStatus ç”¨æ¥è®°å½•å½“å‰çº¿ç¨‹ç­‰å¾…çŠ¶æ€
- prev è®°å½•å‰é©±ç»“ç‚¹ï¼Œnext è®°å½•åç»§èŠ‚ç‚¹
- state è¡¨ç¤ºçŠ¶æ€ä¿¡æ¯ï¼Œå¸¸è¢«è¢«è§†ä¸ºèµ„æºï¼ˆæˆ–è€…è¯´æ˜¯èµ„æºæ•°é‡ï¼‰



### 9.3 æ¡ä»¶å˜é‡



### 9.4 æ¨¡æ¿æ¨¡å¼



### 9.5 AQS ä¸­çš„æ¨¡æ¿æ¨¡å¼

AQS å¯é‡å†™çš„æ–¹æ³•ï¼š

<table>
    <thead>
        <tr>
            <th width="150">æ–¹æ³•å</th>
            <th width="150">å‚æ•°</th>
            <th width="100">è¿”å›ç±»å‹</th>
            <th>è¯´æ˜</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>tryAcquire</td>
            <td>int arg</td>
            <td>boolean</td>
            <td>ç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œå®ç°è¯¥æ–¹æ³•éœ€è¦æŸ¥è¯¢å½“å‰çŠ¶æ€å¹¶åˆ¤æ–­åŒæ­¥çŠ¶æ€æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œç„¶åå†è¿›è¡Œ CAS è®¾ç½®åŒæ­¥çŠ¶æ€</td>
        </tr>
        <tr>
            <td>tryRelease</td>
            <td>int arg</td>
            <td>boolean</td>
            <td>ç‹¬å å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œç­‰å¾…è·å–åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹å°†æœ‰æœºä¼šè·å–åŒæ­¥çŠ¶æ€</td>
        </tr>
    </tbody>
</table>



AQS æä¾›çš„æ¨¡æ¿æ–¹æ³•ï¼š

<table>
    <thead>
        <tr>
            <th width="80">æ–¹æ³•å</th>
            <th width="200">å‚æ•°</th>
            <th width="100">è¿”å›ç±»å‹</th>
            <th>è¯´æ˜</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>acquire</td>
            <td>int arg</td>
            <td>void</td>
            <td>ç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€æˆåŠŸï¼Œåˆ™ç”±è¯¥æ–¹æ³•è¿”å›ï¼Œå¦åˆ™ï¼Œå°†è¿›å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾…ã€‚è¯¥æ–¹æ³•å°†ä¼šè°ƒç”¨é‡å†™çš„ tryAcquire(int arg) æ–¹æ³•ã€‚</td>
        </tr>
        <tr>
            <td>acquireInterruptibly</td>
            <td>int arg</td>
            <td>void</td>
            <td>ä¸ acquire(int arg) æ–¹æ³•ç±»ä¼¼ï¼Œä½†èƒ½å¤Ÿå“åº”ä¸­æ–­ã€‚</td>
        </tr>
        <tr>
            <td>tryAcquireNanos</td>
            <td>int arg, long nanos</td>
            <td>boolean</td>
            <td>åœ¨ acquireInterruptibly(int arg) æ–¹æ³•çš„åŸºç¡€ä¸Šæ·»åŠ äº†è¶…æ—¶é™åˆ¶ï¼Œå¦‚æœåœ¨æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰è·å–åˆ°åŒæ­¥çŠ¶æ€ï¼Œåˆ™è¿”å› false</td>
        </tr>
    </tbody>
</table>



### 9.6 è‡ªå®šä¹‰åŒæ­¥å·¥å…·

```java
public class Mutex implements Lock {
    private static class Sync extends AbstractQueuedSynchronizer {
        // æ˜¯å¦å¤„äºå ç”¨çŠ¶æ€
        protected boolean isHeldExclusively() {
            return getState() == 1;
        }

        public boolean tryAcquire(int acquires) {
            if (compareAndSetState(0, 1)) {
                setExclusiveOwnerThread(Thread.currentThread());
                return true;
            }
            return false;
        }

        protected boolean tryRelease(int releases) {
            if (getState() == 0) {
                throw new IllegalMonitorStateException();
            }
            setExclusiveOwnerThread(null);
            setState(0);
            return true;
        }

        Condition newCondition() {
            return new ConditionObject();
        }
    }

    private final Sync sync = new Sync();

    @Override
    public void lock() {
        sync.acquire(1);
    }

    @Override
    public void lockInterruptibly() throws InterruptedException {
        sync.acquireInterruptibly(1);
    }

    @Override
    public boolean tryLock() {
        return sync.tryAcquire(1);
    }

    @Override
    public boolean tryLock(long time, TimeUnit unit) throws InterruptedException {
        return sync.tryAcquireNanos(1, unit.toNanos(time));
    }

    @Override
    public void unlock() {
        sync.release(1);
    }

    @Override
    public Condition newCondition() {
        return sync.newCondition();
    }
}
```





## 10. CountDownLatch

`CountDownLatch` å¯ä»¥ç¿»è¯‘æˆ**ã€Œå€’è®¡æ•°é—¨é—©ã€**ï¼Œå½“ç„¶ç§°ä¹‹ä¸º **ã€Œå€’è®¡æ•°å™¨ã€** å¯èƒ½ä¼šæ›´å¥½ç†è§£ã€‚ç®€è€Œè¨€ä¹‹ï¼Œè¯¥åŒæ­¥å·¥å…·çš„ä½œç”¨æ˜¯é˜»æ­¢ä¸€ä¸ªçº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼ˆå°±åƒé—¨é—©ä¸€æ ·ï¼‰ï¼Œç„¶åè¿›è¡Œå€’è®¡æ•°ï¼Œè®¡æ•°ç»“æŸåå†å°†è¯¥çº¿ç¨‹æ”¾è¡Œã€‚

<img src="pics/thread-8.png" width="100%"/>

```java
public class CountDownLatchTests {
    public static void main(String[] args) throws InterruptedException {
        CountDownLatch latch = new CountDownLatch(10);
        ExecutorService service = Executors.newFixedThreadPool(5);
        for (int i = 0; i < 10; i++){
            final int num = i+1;
            service.submit(new Runnable() {
                @Override
                public void run() {
                    System.out.println("è®¡æ•°: "+num+" ...");
                    latch.countDown();
                }
            });
        }
        
        // ç­‰å¾…10æ¬¡è®¡æ•°ç»“æŸåç»§ç»­æ‰§è¡Œ
        latch.await();
        System.out.println("åä¸ªä»»åŠ¡å…¨éƒ¨å®Œæˆï¼Œç»§ç»­æ‰§è¡Œä¸»çº¿ç¨‹...");
        
        // è®¡æ•°å™¨è®¡æ•°å®Œæˆåæ— æ³•é‡æ–°å¼€å§‹è®¡æ•°ï¼Œæ‰€ä»¥ä¼šç»§ç»­æ‰§è¡Œä¸‹å»
        latch.await();
        System.out.println("...");

        service.shutdown();
    }
}
```

<left><img src="pics/thread-10.png" width="350"/></left>
## 11. CyclicBarrier

`CyclicBarrier` ç§°ä¸º**ã€Œå¾ªç¯æ …æ ã€**ï¼Œå®ƒå’Œ `CountDownLatch` éå¸¸ç›¸ä¼¼ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå®ƒå°±åƒæ …æ ä¸€æ ·é˜»æ­¢ä¸€ç¾¤çº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼Œå½“è¿™ç¾¤çº¿ç¨‹å…¨éƒ¨åˆ°è¾¾ â€œæ …æ â€ å¤„åå†å°†æ‰€æœ‰çº¿ç¨‹æ”¾è¡Œï¼Œè€Œ â€œå¾ªç¯â€ çš„æ„æ€æ˜¯æŒ‡è¯¥æ …æ å¯ä»¥é‡å¤ä½¿ç”¨ã€‚

<img src="pics/thread-9.png" width="100%"/>

```java
ã€ipublic class CyclicBarrierTests {
    public static void main(String[] args) {
        CyclicBarrier barrier = new CyclicBarrier(3);
        ExecutorService es = Executors.newFixedThreadPool(10);
        
        // å¯åŠ¨3ä¸ªä»»åŠ¡
        for (int i = 0; i < 3; i++) {
            es.submit(new Runnable() {
                @Override
                public void run() {
                    try {
                        
                        // æ¯ä¸ªä»»åŠ¡åˆ†ä¸º3ä¸ªé˜¶æ®µï¼Œè¦æ±‚æ‰€æœ‰ä»»åŠ¡å¿…é¡»å…¨éƒ¨å®Œæˆå½“å‰é˜¶æ®µï¼Œ
                        // æ‰å¯ä¸€èµ·è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µ
                        for(int j = 0; j < 3; j++) {
                            System.out.println("è¯¥ä»»åŠ¡ç¬¬ "+(j+1)+" é˜¶æ®µæ‰§è¡Œå®Œæ¯•");
                            barrier.await();
                        }
                        
                    } catch (Exception e) {e.printStackTrace();}
                }
            });
        }

        es.shutdown();
    }
}
```

> æ³¨æ„ï¼Œè¿™é‡Œçº¿ç¨‹æ± çš„å¤§å°è¦å¤§äºç­‰äº3ï¼Œå¦åˆ™æ°¸è¿œä¸å¯èƒ½æœ‰ä¸‰ä¸ªä»»åŠ¡ä¸€èµ·å®ŒæˆæŸä¸€ä¸ªé˜¶æ®µï¼Œå› ä¸ºçº¿ç¨‹çš„æ•°é‡ä¸å¤ŸåŒæ—¶æ‰§è¡Œ3ä¸ªä»»åŠ¡ã€‚





# é”ä¼˜åŒ–

## 1. è‡ªæ—‹é”

ç”±äºçº¿ç¨‹è¿›å…¥é˜»å¡æ€çš„å¼€é”€æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œè€Œåœ¨å¤§å¤šæ—¶å€™å…±äº«æ•°æ®çš„é”å®šçŠ¶æ€åˆä»…ä»…æŒç»­ä¸€å°æ®µæ—¶é—´ï¼Œäºæ˜¯ JVM ä½¿ç”¨è‡ªæ—‹é”å¯¹è¿™æ ·çš„é—®é¢˜è¿›è¡Œä¼˜åŒ–ã€‚

è‡ªæ—‹é”çš„æ€æƒ³æ˜¯ï¼Œè®©æœ¬åº”è¯¥è¿›å…¥é˜»å¡æ€çš„çº¿ç¨‹å¿™å¾ªç¯ï¼ˆè‡ªæ—‹ï¼‰ä¸€æ®µæ—¶é—´ï¼Œå¦‚æœåœ¨è¿™ä¸€å°æ®µæ—¶é—´å†…èƒ½å¤Ÿè·å–åˆ°é”ğŸ”’ï¼Œå°±èƒ½å¤Ÿé¿å…è¿›å…¥é˜»å¡æ€ã€‚ä½†å¦‚æœè‡ªæ—‹ä¸€å®šæ¬¡æ•°åä¾ç„¶æ²¡æœ‰æŠ¢åˆ°é”ï¼Œåˆ™åœæ­¢è‡ªæ—‹è¿›å…¥é˜»å¡æ€ã€‚



## 2. é”æ¶ˆé™¤

é”æ¶ˆé™¤æ˜¯æŒ‡ JVM å¯¹ä¸å¯èƒ½å­˜åœ¨ç«äº‰çš„å…±äº«æ•°æ®çš„é”è¿›è¡Œæ¶ˆé™¤ã€‚



## 3. é”ç²—åŒ– â€

è™½ç„¶æˆ‘ä»¬å¾€å¾€éƒ½ä¼šè¯´é”çš„ç²’åº¦è¦å°ï¼Œä½†ä¹Ÿå¹¶éæ€»æ˜¯å¦‚æ­¤ã€‚å¦‚æœå‡ºç°ä¸€å—ä»£ç å—**è¿ç»­åå¤åœ°**å‡ºç°åŠ é”ä¸è§£é”æ“ä½œä¼šå¯¼è‡´æ€§èƒ½çš„æŸè€—ï¼Œæˆ‘ä»¬å®Œå…¨æ²¡æœ‰å¿…è¦è®©é”çš„ç²’åº¦å°åˆ°è¿™èˆ¬åœ°æ­¥ã€‚



# JDK å¹¶å‘å®¹å™¨

## 1. æ¦‚è¿°

JDK æä¾›çš„å¹¶å‘å®¹å™¨ä¸»è¦å­˜åœ¨äº `java.util.concurrent` åŒ…ä¸­ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†ä¸è®¸å¤šèƒ½å¤Ÿä¿è¯çº¿ç¨‹å®‰å…¨çš„å®¹å™¨ç±»ï¼Œä¸‹é¢å…ˆåˆ—ä¸¾ä¸€äºŒï¼š

**#1. ** `ConcurrentHashMap`

å¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ä¸ªæ—¢ä¿è¯äº†çº¿ç¨‹å®‰å…¨åˆé«˜æ•ˆçš„ HashMapï¼Œæ€§èƒ½é«˜äºåŒä¸ºçº¿ç¨‹å®‰å…¨çš„ Hashtable ã€‚

**#2.** `CopyOnWriteArrayList`

æ˜¯ä¸€ä¸ª Listï¼Œå’Œ ArrayList ä¸€æ ·åº•å±‚ä½¿ç”¨æ•°ç»„å®ç°ï¼Œåœ¨è¯»å¤šå†™å°‘çš„æƒ…å†µä¸‹æ€§èƒ½å¾ˆå¥½ï¼Œä¸”æ€§èƒ½é«˜äº Vector ã€‚

**#3.** `ConcurrentLinkedQueue`

ä½¿ç”¨é“¾è¡¨å®ç°çš„é«˜æ•ˆå¹¶å‘é˜Ÿåˆ—ï¼Œå¯çœ‹ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ LinkedList ã€‚

**#4. ** `BlockingQueue`

ä¸€ä¸ªæ¥å£ï¼Œè¡¨ç¤ºé˜»å¡é˜Ÿåˆ—ã€‚è¯¥æ¥å£æœ‰å„ç§æ–¹å¼çš„å®ç°ï¼Œå¦‚é“¾è¡¨ã€æ•°ç»„ ã€‚

**#5.** `ConcurrentSkipListMap`

è·³è¡¨çš„å®ç°ï¼Œä»åå­—ä¸Šå¯ä»¥çœ‹åˆ°æ˜¯ä¸€ä¸ª Mapï¼Œå¯ä»¥è¿›è¡Œå¿«é€ŸæŸ¥æ‰¾ã€‚



## 2. ä¸å®‰å…¨çš„ HashMap

### 2.1 HashMap çš„å¹¶å‘é—®é¢˜

åœ¨å¹¶å‘æƒ…å†µä¸‹ï¼ŒJava çš„å“ˆå¸Œè¡¨ï¼ˆHashMapï¼‰åœ¨æ‰©å®¹æ—¶æœ‰å¯èƒ½å‡ºç°å•å‘é“¾è¡¨å¾ªç¯å¼•ç”¨çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨å•å‘é“¾è¡¨ä¸­å‡ºç°äº†ç¯ã€‚å¯ä»¥æƒ³è±¡åˆ°ï¼Œå½“éå†å«æœ‰ç¯çš„å•å‘é“¾è¡¨æ—¶ï¼Œå°±ä¼šå‡ºç°æ­»å¾ªç¯ï¼š

<left><img src="pics/thread-6.png" /></left>
å°è¯•æ¨¡æ‹Ÿå¼•å‘ HashMap çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼š

```java
public class UnsafeHashMapTests {
    public static void main(String[] args) {
        HashMap<String, String> map = new HashMap<>(2);

        Runnable task = () -> {
            for (int i = 0; i < 1000000; i++) {
                String uuid = UUID.randomUUID().toString();
                map.put(uuid,"");
                System.out.println("put....");
                map.get(uuid);
                System.out.println("get....");

            }
        };


        new Thread(task).start();
        new Thread(task).start();
    }
}
```



å½“æˆ‘è¿è¡Œåˆ°å¦‚ä¸‹æƒ…æ™¯æ—¶ç¨‹åºå·²ç»å¡æ­»ä¸åŠ¨äº†ï¼š

<left><img src="pics/thread-7.png" width="350" /></left>
### 2.2 ä½¿ç”¨ Hashtable

å¦‚æœç‚¹å‡»æŸ¥çœ‹ Hashtable çš„æºä»£ç å¯ä»¥å‘ç°å®ƒå‡ ä¹æ‰€æœ‰çš„æ–¹æ³•éƒ½æ·»åŠ äº† `synchronized` å…³é”®è¯ï¼Œæ‰€ä»¥ Hashtable æ˜¯çº¿ç¨‹å®‰å…¨çš„è€Œä¸ä¼šå‡ºç°å’Œ HashMap ä¸€æ ·çš„é—®é¢˜ï¼Œä½†æ˜¯æ—¢ç„¶ä½¿ç”¨äº†é”å…¶æ€§èƒ½ä¹ŸåŠ¿å¿…ä¼šä¸‹é™ã€‚



### 2.3 ConcurrentHashMap

ConcurrentHashMap åŒæ ·æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ€§èƒ½è¦è¿œå¥½äº Hashtableã€‚ä¹‹æ‰€ä»¥èƒ½æ—¢ä¿è¯çº¿ç¨‹å®‰å…¨åˆé«˜æ•ˆçš„åŸå› æ˜¯ï¼ŒHashtable ç›´æ¥ä½¿ç”¨ synchronized å…³é”®è¯å°†æ•´ä¸ª Map æ•°æ®é”ä½äº†ï¼Œè€Œ ConcurrentHashMap ä½¿ç”¨çš„æ˜¯**ã€Œåˆ†æ®µé”ã€**ï¼Œåªé”ä½å¿…è¦çš„éƒ¨åˆ†è€Œé™ä½äº†é”çš„ç²’åº¦ã€‚

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒHashMap æœ‰ 16 ä¸ªæ¡¶ï¼ŒConcurrentHashMap äº¦æ˜¯å¦‚æ­¤ï¼Œæ‰€ä»¥ ConcurrentHashMap é»˜è®¤åˆ†é… 16 æŠŠé”ï¼Œæ¯ä¸€æŠŠé”å¯¹åº”ä¸€ä¸ªæ¡¶ã€‚ä¾‹å¦‚ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å¯¹æŸä¸€ä¸ªæ¡¶è¿›è¡Œæ’å…¥æ“ä½œæ—¶ï¼Œä»…å¯¹è¯¥æ¡¶è¿›è¡ŒåŠ é”ã€‚å¯¹äº Hashtable æ¥è¯´ï¼ŒåŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œæ’å…¥æ“ä½œï¼›å¯¹äº ConcurrentHashMap æ¥è¯´ï¼ŒåŒæ—¶æœ€å¤šå¯ä»¥æœ‰ 16 ä¸ªçº¿ç¨‹è¿›è¡Œæ’å…¥æ“ä½œï¼Œæ•ˆç‡æå¤§æå‡ã€‚



## 3. è·å–çº¿ç¨‹å®‰å…¨çš„å®¹å™¨

Collections æä¾›äº†å¤šä¸ªé™æ€æ–¹æ³•æ¥å°† Java å®¹å™¨å°è£…ä¸ºä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å®¹å™¨ï¼š

```java
// å°† List å˜ä¸ºçº¿ç¨‹å®‰å…¨çš„
List<String> list = new LinkedList<>();
List<String> safeList = Collections.synchronizedList(list);

// å°† Map å˜ä¸ºçº¿ç¨‹å®‰å…¨çš„
HashMap<String,String> map = new HashMap<>(16,1);
Map<String,String> safeMap = Collections.synchronizedMap(map);

// å°† Collection å˜ä¸ºçº¿ç¨‹å®‰å…¨çš„
Collection<String> col = new ArrayList<>();
Collection<String> safeCol = Collections.synchronizedCollection(col);

// ... ...
```



æ‰“å¼€æºç å°±å¯ä»¥å‘ç°ï¼Œå®é™…ä¸Š Collections åªæ˜¯å¯¹æ¥å£æ–¹æ³•å…¨éƒ¨åŠ ä¸Šäº† synchronized å…³é”®è¯ã€‚



# å¹¶å‘ä¸­çš„æ¨¡å¼ä¸ç®—æ³•

## 1. CAS



## 2. çº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼

```java
public class Singleton {
	private Singleton() {}
	
	private static class Inner {
		static Singleton instance = new Singleton();
	}
	
	public static Singleton getInstance() {
		return Inner.instance;
	}
}

```







## 3. ThreadLocal

### 3.1 æ¦‚è¿°ä¸ä½¿ç”¨ç¤ºä¾‹

ThreadLocal æ˜¯ç”± JDK æä¾›çš„ä¸€ä¸ªå·¥å…·ç±»ï¼Œå®ƒä¹Ÿæ˜¯è§£å†³å¹¶å‘é—®é¢˜çš„ä¸€ç§æ€è·¯ã€‚ThreadLocal ç»´æŠ¤å˜é‡æ—¶ï¼Œå®ƒä¼šä¸ºæ¯ä¸€æ¡è¦ä½¿ç”¨åˆ°è¯¥å˜é‡çš„çº¿ç¨‹åˆ›å»ºä¸€ä¸ªå˜é‡çš„å‰¯æœ¬ï¼Œçº¿ç¨‹åªä¼šè®¿é—®ã€æ“ä½œå±äºè‡ªå·±çš„å˜é‡å‰¯æœ¬ã€‚



```java
public class TestThreadLocal {
	static ThreadLocal<String> localVariable = new ThreadLocal<>();
    
	static void paint() {
		StringBuffer buffer = new StringBuffer();
		buffer.append(Thread.currentThread().getName());
		buffer.append(":  ");
        
        // get æ–¹æ³•
        // è·å–å½“å‰è¿è¡Œçº¿ç¨‹çš„å˜é‡å‰¯æœ¬ï¼ˆæˆ–è€…ç§°ä¸ºæœ¬åœ°å˜é‡ï¼‰
		buffer.append(localVariable.get());
        
		System.out.println(buffer.toString());
	}
	
	public static void main(String[] args) {
		Thread one = new Thread(()->{
            
            // set æ–¹æ³•
            // åˆ›å»ºå½“å‰è¿è¡Œçº¿ç¨‹çš„å˜é‡å‰¯æœ¬
			localVariable.set("thread-one");
            
			paint();
            
            // remove æ–¹æ³•
            // ç§»é™¤å½“å‰è¿è¡Œçº¿ç¨‹çš„å˜é‡å‰¯æœ¬
			localVariable.remove();
		}, "ThreadOne");
		
		Thread two = new Thread(()->{
			localVariable.set("thread-two");
			paint();
			localVariable.remove();
		}, "ThreadTwo");
		
		one.start();
		two.start();
	}
}

```



ä¸åŒçº¿ç¨‹å°±åƒæ˜¯å¹³è¡Œä¸–ç•Œä¸€æ ·ï¼Œæ¯ä¸ªä¸–ç•Œçº¿éƒ½å¯èƒ½å®Œå…¨ä¸ä¸€æ ·ã€‚çº¿ç¨‹å…±äº«çš„å¯¹è±¡å°±åƒæ˜¯**ã€Œç©¿æ¢­è€…ã€**ï¼Œå¤„äºä¸Šå¸è§†è§’ï¼Œè„±ç¦»äº†ä¸–ç•Œçº¿çš„çº¦æŸã€‚è€Œ ThreadLocal åˆ™åƒæ˜¯ä¸€ä¸ªç”Ÿå­˜äºå¤šä¸ªä¸–ç•Œçº¿çš„è§’è‰²ï¼Œä¸åŒä¸–ç•Œçº¿çš„ ThreadLocal æ˜¯åŒä¸€ä¸ªäººï¼Œä½†åˆå®Œå…¨ä¸ä¸€æ ·ä¸”äº’ä¸å¹²æ‰°ã€‚



### 3.2 ThreadLocal å®ç°åŸç†

<left><img src="pics/thread-4.png" width="650px" /></left>
<left><img src="pics/thread-5.png" width="450px" /></left>
### 3.3 InheritableThreadLocal



## 4. ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…

### 4.1 æ¦‚è¿°

**ã€Œç”Ÿäº§è€…â€”æ¶ˆè´¹è€…ã€**æ¨¡å¼ä¸ºå¤šçº¿ç¨‹åä½œæä¾›äº†ä¸€ä¸ªè‰¯å¥½ä¸”æ˜“ç†è§£çš„è§£å†³æ–¹æ¡ˆã€‚å…¶åŸºæœ¬çš„æ€æƒ³è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œæ•´ä¸ªæ¨¡å¼çš„é‡è¦è§’è‰²æœ‰ä»¥ä¸‹å‡ ç±»ï¼š

- ç”Ÿäº§è€…ï¼šä¸“é—¨äº§ç”Ÿæ•°æ®çš„çº¿ç¨‹ï¼ˆç»„ï¼‰
- æ¶ˆè´¹è€…ï¼šæ¶ˆè´¹æ•°æ®çš„çº¿ç¨‹ï¼ˆç»„ï¼‰ï¼Œæ‰€æ¶ˆè´¹çš„æ•°æ®æ¥è‡ªäºç”Ÿäº§è€…
- æ•°æ®ï¼šå°±åƒå•†å“ä¸€æ ·è¢«ç”Ÿäº§è€…æ‰€ç”Ÿäº§
- ç¼“å†²æ± ï¼šå°±åƒè´§æ¶ä¸€æ ·è¢«ç”¨æ¥å­˜æ”¾ç”Ÿäº§å‡ºæ¥çš„æ•°æ®



å…¶å¤§æ¦‚çš„æµç¨‹å¦‚ä¸‹ï¼š

1. ç”Ÿäº§è€…ç”Ÿäº§äº†æ•°æ®ï¼Œå¹¶å°è¯•å°†æ•°æ®å­˜æ”¾äºç¼“å†²æ± 
2. å¦‚æœç¼“å†²æ± å·²æ»¡ï¼Œåˆ™è¯¥ç”Ÿäº§è€…å¼€å§‹ç­‰å¾…ç¼“å†²æ± å‡ºç°å¯ç”¨ç©ºé—´ç”¨æ¥å­˜æ”¾æ•°æ®
3. æ¶ˆè´¹è€…å°è¯•ä»ç¼“å†²æ± ä¸­æ‹¿å–æ•°æ®
4. å¦‚æœç¼“å†²æ± ä¸­ä¸å­˜åœ¨æ•°æ®ï¼Œåˆ™æ¶ˆè´¹è€…å¼€å§‹ç­‰å¾…æ•°æ®çš„å‡ºç°



è¿™æ ·çš„æ¨¡å¼æœ‰ç€å¾ˆé‡è¦ä¼˜åŠ¿ï¼š

- é€šè¿‡ç¼“å†²æ± å°†ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€… **è§£è€¦** ã€‚æˆ‘ä»¬å¯ä»¥å‘ç°ç”Ÿäº§è€…åªè´Ÿè´£ç”Ÿäº§ã€å­˜æ”¾æ•°æ®ï¼Œè€Œæ¶ˆè´¹è€…åªè´Ÿè´£æ‹¿å–ã€æ¶ˆè´¹æ•°æ®ï¼Œ**å®ƒä»¬äº’ç›¸éƒ½æ— éœ€çŸ¥é“å¯¹æ–¹çš„å­˜åœ¨** ã€‚
- é€šè¿‡ç¼“å†²æ± å¯ä»¥ç¼“è§£ç”Ÿäº§ä»»åŠ¡ä¸æ¶ˆè´¹ä»»åŠ¡çš„æ•ˆç‡å·®å¼‚ã€‚å³ä½¿åœ¨ç¡¬ä»¶ä¸Šï¼Œè®¸å¤šæ•ˆç‡ä¸å¯¹ç­‰çš„é—®é¢˜ä¹Ÿç»å¸¸ä½¿ç”¨ç¼“å†²æ¥è§£å†³ï¼ˆæ¯”å¦‚å­˜å‚¨å™¨çš„ç­‰çº§ç»“æ„ï¼‰ã€‚



### 4.2 ä½¿ç”¨ BlockingQueue çš„å®ç°

```java
/**
  * æ•°æ®
  */
public class PCData { }


/**
  * ç”Ÿäº§è€…
  */
public class Producer implements Runnable {
    private BlockingQueue<PCData> bq;

    public Producer(BlockingQueue<PCData> bq) { this.bq = bq; }
    
    @Override
    public void run() {
        while(true) {
            try {
                Thread.sleep(1000);
                PCData data = new PCData();
                bq.put(data);
                System.out.println("æ”¾å…¥ä¸€ä¸ªæ•°æ®");
            } catch (InterruptedException e) { e.printStackTrace();}
        }
    }
}

/**
  * æ¶ˆè´¹è€…
  */
public class Customer implements Runnable {
    private BlockingQueue<PCData> bq;
    public Customer(BlockingQueue<PCData> bq) { this.bq = bq; }

    @Override
    public void run() {
        while(true) {
            try {
                bq.take();
                System.out.println("æ‹¿èµ°ä¸€ä¸ªæ•°æ®");
            } catch (InterruptedException e) { e.printStackTrace(); }
        }
    }
}


/**
  * æµ‹è¯•ç”¨ä¾‹
  */
public class PCTests {
    /**
      * é˜»å¡é˜Ÿåˆ—ï¼Œç”¨ä½œç¼“å†²æ± 
      */
    static LinkedBlockingQueue<PCData> lbq = new LinkedBlockingQueue<>(2);


    public static void main(String[] args) {
        Producer producer1 = new Producer(lbq);
        Producer producer2 = new Producer(lbq);
        Producer producer3 = new Producer(lbq);

        Customer customer1 = new Customer(lbq);
        Customer customer2 = new Customer(lbq);

        ExecutorService service = Executors.newFixedThreadPool(5);

        service.submit(producer1);
        service.submit(producer2);
        service.submit(producer3);
        service.submit(customer1);
        service.submit(customer2);
    }
}
```